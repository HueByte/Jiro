version: "3.8"

services:
  jiro-kernel:
    container_name: jiro-kernel
    build:
      context: ./src/Jiro.Kernel
      dockerfile: Dockerfile
    ports:
      - "${JIRO_HTTP_PORT}:8080"
      - "${JIRO_HTTPS_PORT}:8443"
      - "${JIRO_ADDITIONAL_PORT}:18090"
    environment:
      # Database connection
      - ConnectionStrings__JiroContext=Server=${DB_SERVER};Database=${MYSQL_DATABASE};Uid=${MYSQL_USER};Pwd=${MYSQL_PASSWORD};
      # Serilog configuration overrides (optional - uncomment to customize)
      # - Serilog__WriteTo__1__Args__path=Data/Logs/jiro-detailed_.txt
      # - Serilog__WriteTo__2__Args__path=Data/Logs/jiro-errors_.txt
      # - Serilog__MinimumLevel__Default=Information
      # OpenAI configuration (required for AI features)
      # - Chat__AuthToken=${OPENAI_API_KEY}
      # JWT configuration (required for authentication)
      # - JWT__Secret=${JWT_SECRET}
      # - JWT__Issuer=${JWT_ISSUER}
      # - JWT__Audience=${JWT_AUDIENCE}
    volumes:
      - jiro_data:/home/app/jiro/Data
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - jiro-network
    restart: unless-stopped

  mysql:
    container_name: jiro-mysql
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    ports:
      - "${MYSQL_PORT}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - mysql_config:/etc/mysql/conf.d
    networks:
      - jiro-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u${MYSQL_USER}",
          "-p${MYSQL_PASSWORD}",
        ]
      interval: ${MYSQL_HEALTH_CHECK_INTERVAL}
      timeout: ${MYSQL_HEALTH_CHECK_TIMEOUT}
      retries: ${MYSQL_HEALTH_CHECK_RETRIES}
      start_period: ${MYSQL_HEALTH_CHECK_START_PERIOD}

volumes:
  jiro_data:
    driver: local
  mysql_data:
    driver: local
  mysql_config:
    driver: local

networks:
  jiro-network:
    driver: bridge
